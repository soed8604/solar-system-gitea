name: Cleanup Preview Environment

on:
  # Cuando se cierra/mergea un PR
  pull_request:
    types: [closed]
    branches:
      - main
  # Cuando se elimina una rama
  delete:

env:
  AWS_REGION: us-west-2
  EKS_CLUSTER_NAME: cluster-k8s-staging

jobs:
  cleanup:
    name: Cleanup Preview Environment
    runs-on: ubuntu-latest
    # Solo ejecutar si es una rama (no un tag)
    if: github.event_name == 'pull_request' || (github.event_name == 'delete' && github.event.ref_type == 'branch')
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Get branch name
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Para PR cerrado, obtener la rama fuente
            BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          else
            # Para delete, obtener la rama eliminada
            BRANCH_NAME="${{ github.event.ref }}"
          fi

          # Sanitizar nombre de rama para K8s
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | tr '/' '-' | tr '[:upper:]' '[:lower:]' | cut -c1-63)
          echo "name=$SAFE_BRANCH" >> $GITHUB_OUTPUT
          echo "original=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Branch to cleanup: $BRANCH_NAME -> $SAFE_BRANCH"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-cleanup
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Configure Kubernetes context
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Check if namespace exists
        id: check
        run: |
          NAMESPACE="solar-system-${{ steps.branch.outputs.name }}"
          if kubectl get namespace $NAMESPACE 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Namespace $NAMESPACE exists, will cleanup"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Namespace $NAMESPACE does not exist, skipping cleanup"
          fi

      - name: Delete Helm release
        if: steps.check.outputs.exists == 'true'
        continue-on-error: true
        run: |
          NAMESPACE="solar-system-${{ steps.branch.outputs.name }}"
          RELEASE_NAME="solar-system-${{ steps.branch.outputs.name }}"

          echo "Deleting Helm release: $RELEASE_NAME in namespace: $NAMESPACE"
          helm uninstall $RELEASE_NAME --namespace $NAMESPACE --wait || true

      - name: Delete namespace
        if: steps.check.outputs.exists == 'true'
        continue-on-error: true
        run: |
          NAMESPACE="solar-system-${{ steps.branch.outputs.name }}"

          echo "Deleting namespace: $NAMESPACE"
          kubectl delete namespace $NAMESPACE --wait=true --timeout=5m || true

      - name: Verify cleanup
        if: steps.check.outputs.exists == 'true'
        run: |
          NAMESPACE="solar-system-${{ steps.branch.outputs.name }}"

          # Esperar un momento para que se complete la eliminación
          sleep 10

          if kubectl get namespace $NAMESPACE 2>/dev/null; then
            echo "⚠️ Warning: Namespace $NAMESPACE still exists"
          else
            echo "✅ Namespace $NAMESPACE successfully deleted"
          fi

      - name: Print cleanup info
        run: |
          echo "=============================================="
          echo "Preview Environment Cleanup"
          echo "=============================================="
          echo "Branch: ${{ steps.branch.outputs.original }}"
          echo "Namespace: solar-system-${{ steps.branch.outputs.name }}"
          echo "Status: ${{ steps.check.outputs.exists == 'true' && 'Cleaned up' || 'Not found (already cleaned)' }}"
          echo "=============================================="
