name: Cleanup Preview Environment

on:
  pull_request:
    types: [closed]
    branches:
      - main

env:
  AWS_REGION: us-west-2
  EKS_CLUSTER_NAME: cluster-k8s-staging

jobs:
  cleanup:
    name: Cleanup Preview Environment
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write  # Requerido para OIDC

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-cleanup
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Configure Kubernetes context
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Delete Helm release
        continue-on-error: true
        run: |
          NAMESPACE="solar-system-pr-${{ github.event.pull_request.number }}"
          RELEASE_NAME="solar-system-pr-${{ github.event.pull_request.number }}"

          echo "Deleting Helm release: $RELEASE_NAME in namespace: $NAMESPACE"
          helm uninstall $RELEASE_NAME --namespace $NAMESPACE --wait || true

      - name: Delete namespace
        continue-on-error: true
        run: |
          NAMESPACE="solar-system-pr-${{ github.event.pull_request.number }}"

          echo "Deleting namespace: $NAMESPACE"
          kubectl delete namespace $NAMESPACE --wait=true --timeout=5m || true

      - name: Verify cleanup
        run: |
          NAMESPACE="solar-system-pr-${{ github.event.pull_request.number }}"

          if kubectl get namespace $NAMESPACE 2>/dev/null; then
            echo "‚ö†Ô∏è Warning: Namespace $NAMESPACE still exists"
            exit 1
          else
            echo "‚úÖ Namespace $NAMESPACE successfully deleted"
          fi

      - name: Comment PR with cleanup status
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const namespace = `solar-system-pr-${prNumber}`;

            const comment = `## üßπ Preview Environment Cleaned Up

            The preview environment has been successfully cleaned up.

            **Namespace:** \`${namespace}\` - ‚úÖ Deleted
            **Helm Release:** \`${namespace}\` - ‚úÖ Uninstalled

            All resources associated with this PR have been removed.

            ---
            *Cleaned up by GitHub Actions*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

      - name: Cleanup failed
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const namespace = `solar-system-pr-${prNumber}`;

            const comment = `## ‚ö†Ô∏è Preview Environment Cleanup Failed

            The preview environment cleanup encountered an error.

            **Namespace:** \`${namespace}\`
            **Workflow Run:** [View logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            Please manually verify and clean up the namespace if needed:

            \`\`\`bash
            kubectl delete namespace ${namespace}
            \`\`\`

            ---
            *Cleaned up by GitHub Actions*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
