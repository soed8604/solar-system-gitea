name: Deploy Preview Environment

on:
  push:
    branches-ignore:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  AWS_REGION: us-west-2
  EKS_CLUSTER_NAME: cluster-k8s-staging

jobs:
  deploy:
    name: Deploy Preview Environment
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      deployments: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set branch name
        id: branch
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | tr '/' '-' | tr '[:upper:]' '[:lower:]' | cut -c1-63)
          echo "name=$SAFE_BRANCH" >> $GITHUB_OUTPUT
          echo "original=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Branch: $BRANCH_NAME -> $SAFE_BRANCH"

      - name: Create GitHub Deployment
        id: deployment
        uses: actions/github-script@v7
        env:
          BRANCH_NAME: ${{ steps.branch.outputs.name }}
          BRANCH_ORIGINAL: ${{ steps.branch.outputs.original }}
        with:
          script: |
            const branchName = process.env.BRANCH_NAME;
            const branchOriginal = process.env.BRANCH_ORIGINAL;
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: `preview-${branchName}`,
              auto_merge: false,
              required_contexts: [],
              description: `Preview environment for ${branchOriginal}`
            });
            core.setOutput('id', deployment.data.id);

      - name: Set Deployment In Progress
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_ID: ${{ steps.deployment.outputs.id }}
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: parseInt(process.env.DEPLOYMENT_ID),
              state: 'in_progress',
              description: 'Deployment in progress...'
            });

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.branch.outputs.name }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.branch.outputs.name }}-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Configure Kubernetes context
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Create namespace
        run: |
          NAMESPACE="solar-system-${{ steps.branch.outputs.name }}"
          kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
          kubectl label namespace $NAMESPACE \
            environment=preview \
            branch=${{ steps.branch.outputs.name }} \
            --overwrite

      - name: Deploy with Helm
        run: |
          NAMESPACE="solar-system-${{ steps.branch.outputs.name }}"
          IMAGE_TAG="${{ steps.branch.outputs.name }}"

          helm upgrade --install \
            solar-system-${{ steps.branch.outputs.name }} \
            ./helm \
            --namespace $NAMESPACE \
            --create-namespace \
            --values ./helm/values-preview.yaml \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=$IMAGE_TAG \
            --set namespace=$NAMESPACE \
            --set branchName=${{ steps.branch.outputs.name }} \
            --set environment=preview \
            --wait \
            --timeout 5m

      - name: Wait for ALB and get URL
        id: alb
        run: |
          NAMESPACE="solar-system-${{ steps.branch.outputs.name }}"

          echo "Waiting for ALB to be provisioned..."
          for i in {1..30}; do
            ALB_URL=$(kubectl get ingress -n $NAMESPACE -o jsonpath='{.items[0].status.loadBalancer.ingress[0].hostname}' 2>/dev/null || true)
            if [ -n "$ALB_URL" ]; then
              echo "ALB URL: $ALB_URL"
              echo "url=http://$ALB_URL" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "Waiting for ALB... attempt $i/30"
            sleep 10
          done
          echo "ALB not ready after 5 minutes"
          echo "url=pending" >> $GITHUB_OUTPUT

      - name: Update Deployment Status - Success
        if: success()
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_ID: ${{ steps.deployment.outputs.id }}
          ALB_URL: ${{ steps.alb.outputs.url }}
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: parseInt(process.env.DEPLOYMENT_ID),
              state: 'success',
              environment_url: process.env.ALB_URL,
              description: 'Deployment successful!'
            });

      - name: Update Deployment Status - Failure
        if: failure()
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_ID: ${{ steps.deployment.outputs.id }}
        with:
          script: |
            const deploymentId = process.env.DEPLOYMENT_ID;
            if (deploymentId) {
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: parseInt(deploymentId),
                state: 'failure',
                description: 'Deployment failed'
              });
            }

      - name: Print deployment info
        if: always()
        run: |
          echo "=============================================="
          echo "Preview Environment Deployed!"
          echo "=============================================="
          echo "Branch: ${{ steps.branch.outputs.original }}"
          echo "Namespace: solar-system-${{ steps.branch.outputs.name }}"
          echo "URL: ${{ steps.alb.outputs.url }}"
          echo "=============================================="
